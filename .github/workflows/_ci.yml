name: Reusable CI Workflow

permissions:
  contents: read
on:
  workflow_call:
    inputs:
      task:
        description: "CI task to run"
        required: true
        type: string
      bazel-extra:
        description: "Extra bazel args"
        required: false
        type: string
      docker-in-docker:
        description: "Enable Docker in Docker"
        required: false
        type: boolean
        default: false
    secrets:
      dockerhub-username:
        description: "DockerHub username"
        required: false
      dockerhub-password:
        description: "DockerHub password"
        required: false

jobs:
  ci:
    name: "./ci/do_ci.sh ${{ inputs.task }}"
    permissions:
      contents: read
      packages: read
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v6.0.1
    - name: Set gcc
      run: |
        if [[ "${{ inputs.task }}" == *"gcc"* ]]; then
          echo "build --config=gcc" >> repo.bazelrc
        else
          echo "common --config=clang" >> repo.bazelrc
        fi
    - name: Configure repo Bazel settings
      run: |
        echo "common --jobs=200" >> repo.bazelrc
        echo "build --config=bes" >> repo.bazelrc
    - name: Bind mount spare disk for build artifacts
      uses: envoyproxy/toolshed/gh-actions/bind-mounts@actions-v0.4.1
      with:
        mounts: |
          - src: /mnt/envoy-docker-build
            target: /tmp/envoy-docker-build
            chown: runner:runner
          - src: /mnt/bazel-shared
            target: /tmp/bazel-shared
            chown: runner:runner
    - name: Run CI script
      run: |
        ./ci/run_envoy_docker.sh './ci/do_ci.sh ${{ inputs.task }}'
      env:
        GITHUB_TOKEN: ${{ github.token }}
        BAZEL_BUILD_EXTRA_OPTIONS: >-
          --config=remote-ci
          --config=rbe
          ${{ inputs.bazel-extra }}
        GH_BRANCH: ${{ github.ref }}
        GH_SHA1: ${{ github.sha }}
        ENVOY_DOCKER_IN_DOCKER: ${{ inputs.docker-in-docker && '1' || '' }}
        DOCKERHUB_USERNAME: ${{ secrets.dockerhub-username }}
        DOCKERHUB_PASSWORD: ${{ secrets.dockerhub-password }}

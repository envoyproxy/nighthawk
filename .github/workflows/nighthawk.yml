name: Nighthawk/Test CI/CD

permissions:
  contents: read
on:
  pull_request:
  push:
    branches:
    - main
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true


jobs:
  check_format:
    permissions:
      contents: read
      packages: read
    uses: ./.github/workflows/_ci.yml
    with:
      task: check_format

  build:
    permissions:
      contents: read
      packages: read
    uses: ./.github/workflows/_ci.yml
    with:
      task: build

  test:
    permissions:
      contents: read
      packages: read
    needs: build
    strategy:
      fail-fast: false
      matrix:
        target:
        - asan
        - benchmark_with_own_binaries
        - test
        - test_gcc
        - tsan
    uses: ./.github/workflows/_ci.yml
    with:
      task: ${{ matrix.target }}

  release:
    secrets:
      dockerhub-username: >-
        ${{ (github.event_name == 'push'
             && github.ref == 'refs/heads/main')
            && secrets.DOCKERHUB_USERNAME
            || '' }}
      dockerhub-password: >-
        ${{ (github.event_name == 'push'
             && github.ref == 'refs/heads/main')
            && secrets.DOCKERHUB_PASSWORD
            || '' }}
    permissions:
      contents: read
      packages: read
    needs: test
    uses: ./.github/workflows/_ci.yml
    with:
      task: docker
      bazel-extra: >-
        --config=remote-ci-download
      docker-in-docker: true
